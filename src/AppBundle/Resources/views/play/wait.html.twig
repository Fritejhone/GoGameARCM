{% extends '@App/layout/layout.html.twig' %}

{% block title %}Salon de jeu{% endblock %}

{% block css %}

{% endblock %}

{% block content %}
    <div>
        <div id="data" data-status-game="{{ game.isWaiting }}" data-id-me="{{ user.id }}"
             data-id-game="{{ game.id }}"></div>
        <div class="panel panel-info">
            <div class="panel-heading"><h2 class="text-center" id="opponent-name">Recherche d'un adversaire ...</h2>
            </div>
            <div class="panel-body">
                <div>
                    <div class="row" style="padding-left: 15px">
                        <div id='board' class="col-md-7 col-xs-12" style="background-color: lightgray;">
                            {% for i in 0..12 %}
                                <div class="row">
                                    <div class="col-md-12" style="padding: 0">
                                        {% for j in 0..12 %}
                                            <div class="btn-board empty" data-x="{{ i }}" data-y="{{ j }}"></div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="col-md-5 col-xs-12">
                            <div class="panel" style="border: #2c2c2c solid 1px">
                                <div class="panel-heading" style="background-color: #2c2c2c">
                                    <div class="panel-titles">
                                        <i class="fa fa-comments" aria-hidden="true"></i>
                                        <span style="color: white"><strong>Chat de la partie</strong></span>
                                    </div>
                                </div>
                                <ul class="list list-unstyled panel-body" id="msg-list">
                                    {% for comment in user.game.comments %}
                                    {% include '@App/comment/single.html.twig' %}
                                    {% endfor %}
                                </ul>
                                <div class="panel-footer">
                                    <form method="POST" class="add-comment"
                                          action="{{ path('comment_post', {'id': user.id}) }}">
                                        <div class="form-group">
                                                <textarea
                                                        class="form-control autoExpand"
                                                        name="content"
                                                        required=""
                                                        type="text"
                                                        rows='3'
                                                        data-min-rows='3'>
                                                </textarea>
                                        </div>
                                        <div class="row">
                                            <div class="col-xs-12">
                                                <div class="text-right">
                                                    <input type="hidden" name="game" value="{{ game.id }}">
                                                    <button id='msg_form_btn' class=" clickableElement btn btn-xs btn-dblue">
                                                        <i class="fa fa-send"></i>
                                                        Envoyer
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}

    <script>
        $(function () {

            //Récupération de mon id et de la partie
            let me = $('#data').data('id-me');
            let game = $('#data').data('id-game');

            let myTurn, myColor;

            let opponent, started = 0;

            //Bug de place holder à corriger
            $("textarea[name='content']").val('');

            //En cas de reload on remet les messages en bas de liste
            $('#msg-list').scrollTop($('#msg-list')[0].scrollHeight);

            //Abonnement au channel propre à la partie
            let gameChannel = pusher.subscribe('game-' + game);

            $(".add-comment").submit(function (event) {

                event.preventDefault();

                if(opponent !== 0){
                    sendComment(event, $(this));
                }
                else{
                    $(this).append('<ul class="list-unstyled"><li>Pas d\'adversaire pour le moment</li></ul>'); // Avoir pour mettre un toast qui disparait au cours du temps
                    $("textarea[name='content']").val('');
                }
            });

            //Messagerie en temps réel
            gameChannel.bind('new_comment', function (data) {
                $.get(Routing.generate('get_last_comment', {comment_id: data.message, user_id: me}, false))
                    .done(function (ret) {
                        if (!data.error) {
                            $('#msg-list').append(ret);
                            $('#msg-list').animate({ scrollTop: $('#msg-list').prop("scrollHeight")}, 1000);
                        }
                        else {
                            console.log(data.error);
                        }
                    });
            });

            // A voir si on peut pas faire attendre le premier joueur sur une page avec un loading qui dispatcherait le JS

            //Si la partie est en attente j'écoute l'evenement nouveau joueur
            if ($('#data').data('status-game') === 1 && started === 0) {

                myTurn = true;
                myColor = 0; // équivaut à noir

                // startGame(me, opponent, myTurn, myColor);

                //Notification en temps réel
                gameChannel.bind('new_player', function (data) {
                    opponent = data.message;
                    $.get(Routing.generate('get_player', {id: data.message}, false))
                        .done(function (ret) {
                            if (!data.error) {
                                $('#opponent-name').text('Vous jouez contre ' + ret.pseudo);
                            }
                            else {
                                console.log(data.error);
                            }
                        }).then(function () {
                        console.log('demarrage');
                        started = 1;
                        startGame(me, opponent, myTurn, myColor, gameChannel);

                    });
                });
            }
            else {

                //Check si il y a déjà eu des coups et on repart de l'état précedent en cas de rafraichissement

                //Sinon
                myTurn = false;
                myColor = 1; // équivaut à blanc

                //Look for opponent name
                $.get(Routing.generate('get_opponent', {me: me, game: game}, false))
                    .done(function (ret) {
                        opponent = ret.id;
                        if (!data.error) {
                            $('#opponent-name').text('Vous jouez contre ' + ret.pseudo);
                            startGame(me, opponent, myTurn, myColor, gameChannel);
                            started = 1
                        }
                        else {
                            console.log(data.error);
                        }
                    });
            }

        });

        //Envoi d'un commentaire
        function sendComment(event, _) {

            let content = _.find("textarea[name='content']").val();
            _.find('button').prop('disabled', true);

            $.post(Routing.generate('comment_post', {id: me}), { content: content }).done(function (data) {
                if (!data.error) {
                    //On laisse le temps réel se débrouiller d'afficher la donnée, à voir si c'est le plus pertinent
                    _.find("textarea[name='content']").val('');
                } else {
                    _.append('<ul class="list-unstyled"><li> ' + data.error + '</li></ul>');
                }
            }).always(function () {
                _.find('button').prop('disabled', false);
            })

            ;
        }

        function startGame(me, opponent, myTurn, myColor, gameChannel) {

            //Ecouteur sur l'evenement nouveau coup
            gameChannel.bind('new_turn', function (data) {
                $.get(Routing.generate('get_turn', {id: data.message}, false))
                    .done(function (ret) {
                        if (!data.error) {
                            //Si c'est pas mon tour, mettre à jour le board

                            //Changer le tour de jeu
                            myTurn = !myTurn;
                            console.log(myTurn);
                            // console.log(ret);
                            // startGame(me, opponent, myTurn, myColor);

                        }
                        else {
                            console.log(data.error);
                        }
                    })
            });

            //Ecouteur sur les boutons
            $('.btn-board').each(function () {
                $(this).on("click", function () {
                    //Si c'est mon tour
                    console.log(myTurn);
                    if (myTurn && $(this).hasClass('empty')) {
                        // console.log($(this).data('x') + '-' + $(this).data('y'));

                        //Remplacer les if par une condition ternaire
                        if (myColor === 1) {
                            $(this).removeClass('empty');
                            $(this).addClass('white');
                        }

                        if (myColor === 0) {
                            $(this).removeClass('empty');
                            $(this).addClass('black');
                        }

                        //AJAX request to tell backend that there is a new turn
                        $.post(Routing.generate('new_turn', {id: me}), {color: myColor, posX: $(this).data('x'), posY : $(this).data('y')})
                            .done(function (ret) {
                                if (!data.error) {
                                    console.log('vous venez de jouer votre tour');
                                }
                                else{
                                    console.log(data.error);
                                }
                            });

                        //Calcul des points + fin de partie
                    }
                })
            });
        }
    </script>

{% endblock %}