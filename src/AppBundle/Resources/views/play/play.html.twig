{% extends '@App/layout/layout.html.twig' %}

{% block title %}Salon de jeu{% endblock %}

{% block css %}

{% endblock %}

{% block content %}
    <div>
        <div id="data" data-status-game="{{ game.isWaiting }}" data-id-me="{{ user.id }}"
             data-id-game="{{ game.id }}"></div>
        <div class="panel panel-info">
            <div class="panel-heading"><h2 class="text-center" id="opponent-name">Recherche d'un adversaire ...</h2>
            </div>
            <div class="panel-body">
                <div>
                    <div class="row">
                        <div class="col-md-7 col-xs-12" style="background-color: lightgray;">
                            {% for i in 0..12 %}
                                <div class="row">
                                    <div class="col-md-12" style="padding: 0">
                                        {% for j in 0..12 %}
                                            <div class="btn-board empty" data-x="{{ i }}" data-y="{{ j }}"></div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="col-md-5 col-xs-12">
                            <div class="panel" style="border: #2c2c2c solid 1px">
                                <div class="panel-heading" style="background-color: #2c2c2c">
                                    <div class="panel-titles">
                                        <i class="fa fa-comments" aria-hidden="true"></i>
                                        <span style="color: white"><strong>Chat de la partie</strong></span>
                                    </div>
                                </div>
                                <div class="panel-body" style="min-height: 200px">
                                    {#{% for comment in game.comments %}#}
                                    {#{% include '@App/comment/single.html.twig' %}#}
                                    {#{% endfor %}#}
                                </div>
                                <div class="panel-footer">
                                    <form method="POST" class="add-comment"
                                          action="{{ path('comment_post', {'id': game.id}) }}">
                                        <div class="form-group">
                                                <textarea
                                                        class="form-control autoExpand"
                                                        name="content"
                                                        required=""
                                                        type="text"
                                                        rows='3'
                                                        data-min-rows='3'>
                                                </textarea>
                                        </div>
                                        <div class="row">
                                            <div class="col-xs-12">
                                                <div class="text-right">
                                                    <input type="hidden" name="game" value="{{ game.id }}">
                                                    <button class=" clickableElement btn btn-xs btn-dblue">
                                                        <i class="fa fa-send"></i>
                                                        Envoyer
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}

    <script>
        $(function () {

            let me = $('#data').data('id-me');
            let game = $('#data').data('id-game');
            let opponent;

            //Abonnement au channel propre à la partie
            let gameChannel = pusher.subscribe('game-' + game);

            //Si la partie est en attente j'écoute l'evenement nouveau joueur
            if ($('#data').data('status-game') === 1) {
                //Notification en temps réel
                gameChannel.bind('new_player', function (data) {
                    opponent = data.message;
                    $.get(Routing.generate('get_player', {id: data.message}, false))
                        .done(function (ret) {
                            if (!data.error) {
                                $('#opponent-name').text('Vous jouez contre ' + ret.pseudo);
                            }
                            else {
                                console.log(data.error);
                            }
                        }).then(function () {
                        startGame(me, opponent);

                    });
                });
            }
            else {
                //Look for opponent name
                $.get(Routing.generate('get_opponent', {me: me, game: game}, false))
                    .done(function (ret) {
                        opponent = ret.id;
                        if (!data.error) {
                            $('#opponent-name').text('Vous jouez contre ' + ret.pseudo);
                        }
                        else {
                            console.log(data.error);
                        }
                    }).then(function () {
                    startGame(me, opponent);

                });
            }

        });

        function startGame(me, opponent) {

            let myTurn, myColor;

            //Le premier à jouer est le premier connecté
            if (me < opponent) {
                myTurn = true;
                myColor = 0; // équivaut à noir
            }
            else {
                myTurn = false;
                myColor = 1; // équivaut à blanc
            }

            //Creation event chat

            //Ecouteur sur les boutons
            $('.btn-board').each(function () {
                $(this).on("click", function () {
                    //Si c'est mon tour
                    if (myTurn && $(this).hasClass('empty')) {
                        console.log($(this).data('x') + '-' + $(this).data('y'));
                        if (myColor === 1) {
                            $(this).removeClass('empty');
                            $(this).addClass('white');
                        }

                        if (myColor === 0) {
                            $(this).removeClass('empty');
                            $(this).addClass('black');
                        }

                        //Envoie l'event comme quoi le joueur à choisi une case
                        //MAJ la BDD
                        //Change le statut du tour


                        // $.post(Routing.generate('new_turn', {id: me, color: myColor, posX: $(this).data('x'), posY : $(this).data('y')}, false))
                        //     .done(function (ret) {
                        //         if (!data.error) {
                        //             console.log('vous venez de jouer votre tour');
                        //         }
                        //         else{
                        //             console.log(data.error);
                        //         }
                        //     }).then(function () {
                        //     startGame(me, opponent);
                        //
                        // });

                        //Calcul des points + fin de partie
                    }
                })
            });


            //Ecouteur sur l'evenement nouveau coup
            // Si c'est pas mon tour
            if (!myTurn) {
                //MAJ le board
                //Change le statut du tour

            }

        }
    </script>

{% endblock %}